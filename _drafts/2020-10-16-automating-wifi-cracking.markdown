---
title: "Automating WiFi Cracking"
layout: post
date: 2020-10-16
tags: wifi, security
---

In this post we are going to describe how WiFi networks are cracked and write up
some simple code to help automate the process.

<!--more-->

## Level-0: How do you "crack" a WiFi network

The first thing we need to do is understand more about how WiFi networks work
and define what it means to "crack" a WiFi network.

A WiFi network is a wireless network that uses the [IEEE
802.11](https://en.wikipedia.org/wiki/IEEE_802.11) protocols. The 802.11
collection of protocols has a number of security specific protocols we all know
and love. Namely, WEP (now dead thankfully), WPA & WPA2 which are the most
widely deployed standards today, and finally WPA3 which fixes the most glaring
issues with WPA & WPA2 but has yet to be widely deployed. These wireless
security protocols define how a client (i.e. Your phone) and access point (aka.
Wireless Router) authenticate with each other, and how packets are encrypted so
that outsiders can't snoop on or alter the wireless traffic. 

WEP was discovered to have some very serious flaws and for all practical
purposes is not longer in use. You can read more about [WEP's security issues here](https://etutorials.org/Networking/Wireless+lan+security/Chapter+6.+Wireless+Vulnerabilities/WEP+Keystream+and+Plaintext+Recovery/).

WPA & WPA2 are the most widely deployed WiFi security protocols today.
WPA and WPA2 are essentially the same protocol with the exception that WPA2
requires stronger encryption algorithms to be in use. For the remainder of this
article I will refer to WPA and WPA2 interchangeably simply as WPA. 

WPA generally comes in two flavors. WPA _Personal_ is what you will find on most 
home routers where there is a single static password, called the Pre-Shared Key, that 
is needed to login. WPA _Enterprise_ uses the same basic process as WPA Personal
but instead of a static password a
[RADIUS](https://en.wikipedia.org/wiki/RADIUS) server is used to validate the
login parameters.

WPA3 is an evolution of WPA2 and addresses the core weakness of WPA that we will
target in our attacks today. However, WPA3 is not widely deployed and most devices 
and access points do not support WPA3 yet.

Since WPA Personal is the most commonly deployed protocol, that is what we will
focus on attempting to crack. 

### WPA Personal 3-way handshake

WPA clients, called stations, and Access Points (APs) authenticate each other
using the 3-way handshake which is part of the WPA protocol. There are a couple
of data items that go into the 3-way handshake.

Pre-Shared Key (PSK)
: This is the WPA password you type in when you connect to the network.

Pairwise Master Key (PMK)
: This is derived from the Pre-Shared Key using `PBKDF2(HMACâˆ’SHA1, PSK, SSID,
4096, 256)`.

ANonce and SNonce
: One-time use nonces generated by the AP and Station when establishing a new
connection.

Pairwise Transient Key (PTK)
: Custom hash of `PMK || ANonce || SNonce || AP Mac || Station Mac`. Different
parts of this key are used to authenticate the connection and to encrypt
the traffic to an AP. 

Message Integrity Control (MIC)
: HMAC of the frame's payload using the first 128-bits of the PTK as the HMAC
key.

Group Temporal Key (GTK)
: Constructed by the Access Point and shared with authenticated clients. Used to
encrypt broadcast data.

When authenticating a connection, the station (aka client or your laptop) will
send an Authentication Frame to the Access Point kicking of the 3-way handshake.

The first part of the handshake consists of the Access Point sending the ANonce
and a counter, called the Reply Counter, to the station. 

Using the ANonce the station selects an SNonce and constructs the Pairwise
Transient Key using the ANonce received from the previous frame. As the second
part of the handshake the station replies to the AP with the MIC, proving the
station was able to compute the PTK, along with the SNonce it selected and the
incremented Reply Counter.

In the third and final step of the handshake the Access Point verifies the MIC
constructed by the station, thus proving to the Access Point that the Station
was able to construct the correct PTK (or at least the first 128-bytes).  The AP
replies back with the Group Temporal Key and a MIC, proving to the station that
the AP was also able to construct the correct PTK completing the authentication
process. 

### Attacking the 3-way handshake

In the 3-way handshake the ANonce, SNonce and MIC are all transmitted in the
clear when establishing a new connection. The AP Mac and Station Mac addresses
are also easily available, so the only thing missing that is needed to
re-construct the PTK is the Pairwise Master Key which is derived directly from
the WPA password, and we will know we have constructed the correct PTK if we are
able to derive the correct MIC. This allows a specific type of attack called an
Offline Dictionary Attack. In short, if we are able to capture the WPA 3-way
handshake then we can start guessing passwords (i.e. perform a dictionary
attack) and check the results without the need to connect to the Access Point or
the Stations, i.e we can check our guesses offline. 

## Level-1: Do it by hand


